<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confucian Café · Unified Interaction Prototype</title>
  <style>
    :root {
      --ink: #1a1a1a;
      --bg: #f4f1e8;
      --panel: rgba(255, 255, 255, 0.96);
      --red: #8b1414;
      --gold: #d99a00;
      --jade: #0ea16a;
      --slate: rgba(25, 25, 25, 0.55);
      --muted: rgba(25, 25, 25, 0.34);
      --shadow: 0 28px 60px rgba(0, 0, 0, 0.14);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: radial-gradient(circle at 30% -10%, rgba(217, 154, 0, 0.12), transparent 55%),
                  radial-gradient(circle at 90% 0%, rgba(139, 20, 20, 0.16), transparent 52%),
                  linear-gradient(120deg, #fbfaf5 0%, var(--bg) 58%, #fdf7ea 100%);
      color: var(--ink);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.45;
      min-height: 100vh;
      padding: 36px 0 64px 0;
    }

    .shell {
      width: min(1400px, 96vw);
      margin: 0 auto;
      display: grid;
      gap: 22px;
      background: rgba(255, 255, 255, 0.75);
      border-radius: 26px;
      padding: 28px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
    }

    header.banner {
      display: grid;
      gap: 10px;
    }

    header.banner h1 {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.6px;
      background: linear-gradient(135deg, var(--red), #c96262);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    header.banner p {
      color: var(--slate);
      font-size: 15px;
      max-width: 780px;
    }

    .layout {
      display: grid;
      grid-template-columns: 320px 1fr 360px;
      gap: 18px;
    }

    .panel {
      background: var(--panel);
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      padding: 18px;
      display: grid;
      gap: 16px;
      box-shadow: 0 18px 42px rgba(0, 0, 0, 0.08);
    }

    .panel header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel header h2 {
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--red);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(139, 20, 20, 0.24);
      color: var(--red);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      background: rgba(139, 20, 20, 0.08);
    }

    .mode-toggle {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .mode-toggle button {
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(0, 0, 0, 0.04);
      color: var(--muted);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mode-toggle button.active {
      background: linear-gradient(135deg, rgba(139, 20, 20, 0.9), rgba(205, 92, 92, 0.92));
      border-color: transparent;
      color: white;
      box-shadow: 0 14px 30px rgba(139, 20, 20, 0.22);
    }

    .callout {
      border-left: 3px solid var(--gold);
      border-radius: 12px;
      background: rgba(217, 154, 0, 0.12);
      padding: 10px 12px;
      color: var(--slate);
      font-size: 13px;
    }

    .spec-line {
      display: grid;
      gap: 6px;
      font-size: 13px;
    }

    .spec-line strong { color: var(--red); }

    .conversation-feed {
      display: grid;
      gap: 12px;
      max-height: 540px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .message-card {
      border-radius: 14px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      padding: 14px;
      background: white;
      display: grid;
      gap: 8px;
      position: relative;
    }

    .message-card::after {
      content: attr(data-mode);
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .message-card header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }

    .route-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(14, 161, 106, 0.3);
      background: rgba(14, 161, 106, 0.12);
      font-size: 11px;
      color: var(--jade);
      font-weight: 600;
      text-transform: uppercase;
    }

    .composer {
      display: grid;
      gap: 12px;
      border-radius: 16px;
      border: 1px solid rgba(139, 20, 20, 0.14);
      padding: 14px;
      background: rgba(255, 255, 255, 0.94);
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted);
    }

    select, textarea, input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      padding: 10px;
      font-family: inherit;
      font-size: 13px;
      background: rgba(255, 255, 255, 0.96);
      color: var(--ink);
    }

    textarea { min-height: 90px; resize: vertical; }

    .composer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .composer-actions button {
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      background: linear-gradient(135deg, rgba(139, 20, 20, 0.94), rgba(205, 92, 92, 0.9));
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .composer-actions button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(139, 20, 20, 0.25);
    }

    pre {
      background: rgba(0, 0, 0, 0.05);
      padding: 10px;
      border-radius: 10px;
      font-family: "SF Mono", "Menlo", "Consolas", monospace;
      font-size: 11.5px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .toggle-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .toggle-row button {
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(0, 0, 0, 0.05);
      color: var(--muted);
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
    }

    .section-block {
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: white;
      padding: 12px;
      display: grid;
      gap: 10px;
    }

    .section-block h3 {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--red);
    }

    .code-block { border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 12px; padding: 8px; background: rgba(0, 0, 0, 0.04); }
    .code-block.active { border-color: rgba(139, 20, 20, 0.32); background: rgba(139, 20, 20, 0.08); }
    .json-block pre { background: rgba(0, 0, 0, 0.06); }

    .insight-box {
      border: 1px dashed rgba(139, 20, 20, 0.3);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      display: grid;
      gap: 8px;
      font-size: 12.5px;
      color: var(--slate);
    }

    footer {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
    }

    @media (max-width: 1240px) {
      .layout { grid-template-columns: 1fr; }
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div class="shell">
    <header class="banner">
      <h1>Confucian Café · Unified Interaction Prototype</h1>
      <p>Single-surface concept where you steer the dialogue. Mode toggles shift composer defaults, routing selectors stay visible, and every agent’s prompt template is transparent and editable.</p>
    </header>

    <div class="layout">
      <aside class="panel" id="left-panel"></aside>
      <main class="panel" id="center-panel"></main>
      <aside class="panel" id="right-panel"></aside>
    </div>

    <footer>Agents always emit <em>deliverTo</em> metadata, ensuring the prompt template’s &lt;Recipient&gt; aligns with your chosen route.</footer>
  </div>

  <script type="text/babel">
    const roster = [
      { id: 'confucius', name: 'Confucius', specialty: 'Ritual order' },
      { id: 'mozi', name: 'Mozi', specialty: 'Utility audits' },
      { id: 'laozi', name: 'Laozi', specialty: 'Soft governance' },
      { id: 'mencius', name: 'Mencius', specialty: 'Innate virtue' },
    ];

    const allAgents = [
      ...roster,
      { id: 'synthesis-agent', name: 'Synthesis Agent', specialty: 'Aggregated synthesis' },
    ];

    const defaultPromptConfig = {
      topic: 'Luo River flood control',
      situationBrief: 'Flood levels are rising near Luo River villages; coordinated ritual rehearsal and engineering deployment are required.',
      tone: 'Respectful, analytic',
      cadence: 'Concise paragraphs',
      roundInstruction: 'Respond in English, cite concrete duties, and respect deliverTo recipient.',
      surfaceCap: 120,
      translationPrefs: 'modern,classical',
    };

    const defaultPersonas = {
      confucius: 'Prioritize ritual coherence (li) that drills duties; uphold benevolence (ren). Speak with composed authority.',
      mozi: 'Maximize utility and impartial care; challenge ceremony when it delays measurable benefit. Tone: direct, pragmatic.',
      laozi: 'Advocate wu wei and flexible governance; metaphoric language grounded in natural metaphors.',
      mencius: 'Highlight innate compassion and righteous governance; persuasive analogies rooted in human goodness.',
      'synthesis-agent': 'Blend positions into actionable memos; neutral tone, highlight consensus and tensions.',
    };

    const modeBlueprints = {
      introduce: {
        id: 'introduce',
        label: 'Introduce',
        summary: 'Write the shared problem statement everyone will respond to.',
        composer: {
          placeholder: 'Describe the flood control problem for the council…',
          defaultRoute: 'all',
        },
      },
      'cross-response': {
        id: 'cross-response',
        label: 'Cross-Response',
        summary: 'Direct one philosopher to critique or build on another.',
        composer: {
          placeholder: 'Ask Mozi to challenge Confucius’ ritual timing…',
          defaultRoute: 'mozi',
        },
      },
      synthesis: {
        id: 'synthesis',
        label: 'Synthesis',
        summary: 'Consult the synthesis agent that sees the full dialogue.',
        composer: {
          placeholder: 'Request a synthesis that blends ritual and metrics…',
          defaultRoute: 'synthesis-agent',
        },
      },
    };

    const initialMessages = [
      {
        id: 'm-1',
        author: 'You',
        authorId: 'user',
        deliverTo: 'all',
        mode: 'introduce',
        surface: 'Flood levels on the Luo River are spiking; I need coordinated plans that balance ritual order and rapid engineering response.',
        timestamp: '09:02',
      },
      {
        id: 'm-2',
        author: 'Confucius',
        authorId: 'confucius',
        deliverTo: 'all',
        mode: 'introduce',
        surface: 'Let each hamlet rehearse duties as living ritual so crews move the instant the drums sound.',
        timestamp: '09:04',
      },
      {
        id: 'm-3',
        author: 'Mozi',
        authorId: 'mozi',
        deliverTo: 'confucius',
        mode: 'cross-response',
        surface: 'Confucius, ensure your rites pivot on measured thresholds—when gauges crest, ceremony yields to action.',
        timestamp: '09:06',
      },
    ];

    function App() {
      const [mode, setMode] = React.useState('introduce');
      const [messages, setMessages] = React.useState(initialMessages);
      const [composerText, setComposerText] = React.useState(modeBlueprints[mode].composer.placeholder);
      const [routeTo, setRouteTo] = React.useState(modeBlueprints[mode].composer.defaultRoute);
      const [promptConfig, setPromptConfig] = React.useState(defaultPromptConfig);
      const [agentPersonas, setAgentPersonas] = React.useState(defaultPersonas);
      const [selectedPersona, setSelectedPersona] = React.useState('confucius');
      const [sampleOutputs, setSampleOutputs] = React.useState([]);
      const [showTemplate, setShowTemplate] = React.useState(false);

      React.useEffect(() => {
        const blueprint = modeBlueprints[mode];
        setComposerText(blueprint.composer.placeholder);
        setRouteTo(blueprint.composer.defaultRoute);
      }, [mode]);

      const handleSend = () => {
        if (!composerText.trim()) return;
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const newMessage = {
          id: `msg-${Date.now()}`,
          author: 'You',
          authorId: 'user',
          deliverTo: routeTo,
          mode,
          surface: composerText.trim(),
          timestamp,
        };
        setMessages(prev => [...prev, newMessage]);
        setComposerText('');
        const sample = createSampleOutput(routeTo, promptConfig, agentPersonas, newMessage.surface);
        setSampleOutputs(prev => [sample, ...prev].slice(0, 5));
        mockAutoReply(newMessage, promptConfig, agentPersonas, setMessages, setSampleOutputs);
      };

      const handleConfigChange = (key, value) => {
        setPromptConfig(prev => ({ ...prev, [key]: value }));
      };

      const handlePersonaTextChange = (agentId, text) => {
        setAgentPersonas(prev => ({ ...prev, [agentId]: text }));
      };

      const buildTemplateForAgent = (agentId) => {
        return renderTemplate({
          agentId,
          routeTo,
          mode,
          promptConfig,
          agentPersonas,
          messages,
        });
      };

      return (
        <React.Fragment>
          <LeftPanel
            mode={mode}
            onModeChange={setMode}
            blueprint={modeBlueprints[mode]}
            messages={messages}
          />
          <CenterPanel messages={messages} sampleOutputs={sampleOutputs} />
          <RightPanel
            mode={mode}
            composerText={composerText}
            setComposerText={setComposerText}
            routeTo={routeTo}
            setRouteTo={setRouteTo}
            onSend={handleSend}
            promptConfig={promptConfig}
            onConfigChange={handleConfigChange}
            agentPersonas={agentPersonas}
            selectedPersona={selectedPersona}
            setSelectedPersona={setSelectedPersona}
            onPersonaChange={handlePersonaTextChange}
            buildTemplateForAgent={buildTemplateForAgent}
            showTemplate={showTemplate}
            setShowTemplate={setShowTemplate}
          />
        </React.Fragment>
      );
    }

    function mockAutoReply(triggerMessage, promptConfig, agentPersonas, setMessages, setSampleOutputs) {
      const addressed = allAgents.find(p => p.id === triggerMessage.deliverTo);
      const delay = 900 + Math.random() * 700;
      let responderId;
      let deliverTo;

      if (addressed && addressed.id !== 'synthesis-agent') {
        responderId = addressed.id;
        const targets = ['all', 'synthesis-agent', ...roster.map(p => p.id).filter(id => id !== responderId)];
        deliverTo = targets[Math.floor(Math.random() * targets.length)];
      } else if (triggerMessage.deliverTo === 'synthesis-agent') {
        responderId = 'synthesis-agent';
        deliverTo = 'all';
      } else {
        responderId = roster[Math.floor(Math.random() * roster.length)].id;
        deliverTo = 'all';
      }

      const responderLabel = formatAuthor(responderId);
      setTimeout(() => {
        const responseText = responderId === 'synthesis-agent'
          ? 'Synthesis draft: Merge Confucian rehearsal with Mozi thresholds; routing proposal back to everyone.'
          : `${responderLabel}: Metrics received. Forwarding actionable clause to ${formatRecipient(deliverTo)}.`;

        const reply = {
          id: `auto-${Date.now()}`,
          author: responderLabel,
          authorId: responderId,
          deliverTo,
          mode: triggerMessage.mode,
          surface: responseText,
          timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        };

        setMessages(prev => [...prev, reply]);
        const sample = createSampleOutput(responderId, promptConfig, agentPersonas, responseText, deliverTo);
        setSampleOutputs(prev => [sample, ...prev].slice(0, 5));
      }, delay);
    }

    function createSampleOutput(agentId, promptConfig, agentPersonas, surfaceText, deliverToOverride) {
      const deliverTo = deliverToOverride || agentId;
      const persona = agentPersonas[agentId] || 'Persona pending.';
      return {
        agent: formatAuthor(agentId),
        deliverTo,
        surface: surfaceText || `${formatAuthor(agentId)} response placeholder.`,
        translations: {},
        insight: `Internal note based on persona: ${persona.slice(0, 90)}…`,
        citations: [],
        config: {
          topic: promptConfig.topic,
          tone: promptConfig.tone,
        },
      };
    }

    function renderTemplate({ agentId, routeTo, mode, promptConfig, agentPersonas, messages }) {
      const agent = allAgents.find(a => a.id === agentId);
      const audience = routeTo === 'all' ? 'all' : agentId;
      const recipientRole = agentId === 'synthesis-agent' ? 'synthesis' : 'philosopher';
      const prior = messages.slice(-4).map(msg => {
        return `      <Statement speaker="${formatAuthor(msg.authorId)}" phase="${msg.mode}" recipient="${msg.deliverTo}">
        <![CDATA[${toCData(msg.surface)}]]>
      </Statement>`;
      }).join('\n');
      return `<Prompt>
  <SystemPrompt>
    <Situation source="system" topic="${promptConfig.topic}" phase="${mode}">
      <![CDATA[${toCData(promptConfig.situationBrief)}]]>
    </Situation>
    <GeneralGuidance tone="${promptConfig.tone}" cadence="${promptConfig.cadence}" audience="${audience}">
      <![CDATA[${toCData(promptConfig.roundInstruction)}]]>
    </GeneralGuidance>
    <SystemPersona source="agent-card" philosopher="${agent?.name || agentId}" version="1.0">
      <![CDATA[${toCData(agentPersonas[agentId] || 'Persona TBD.')}]]>
    </SystemPersona>
  </SystemPrompt>
  <Directive type="${mode}" source="router" audience="${audience}">
    <Recipient role="${recipientRole}" target="${agentId}" />
    <Instruction>${promptConfig.roundInstruction}</Instruction>
    <SafetyRules>
      <Rule>Never surface private reasoning in the public answer.</Rule>
      <Rule>Cite traditions accurately; acknowledge uncertainty when evidence is thin.</Rule>
    </SafetyRules>
    <Constraints maxWords="${promptConfig.surfaceCap}" requireTranslations="${promptConfig.translationPrefs}" />
  </Directive>
  <Context conversationId="demo-session" round="${messages.length}" showInsights="true">
    <UserPrompt routedFrom="user" routedTo="${audience}" timestamp="now">
      <![CDATA[${messages[messages.length - 1] ? toCData(messages[messages.length - 1].surface) : ''}]]>
    </UserPrompt>
    <PeerStatements>
${prior || '      <!-- no prior statements -->'}
    </PeerStatements>
  </Context>
  <OutputContract schema="confucian_cafe.v1" source="ui">
<![CDATA[
Return JSON object with keys:
  surface: string
  translations: { modern?: string, classical?: string }
  insight: string
  citations: string[] (optional)
  deliverTo: "all" | "synthesis-agent" | philosopher_id
Ensure surface ≠ insight in wording and respect deliverTo selection.
]]>
  </OutputContract>
</Prompt>`;
    }

    function toCData(value) {
      if (!value) return '';
      return value.replace(/]]>/g, ']]]]><![CDATA[>');
    }

    function LeftPanel({ mode, onModeChange, blueprint, messages }) {
      const modeList = Object.values(modeBlueprints);
      return ReactDOM.createPortal(
        <React.Fragment>
          <header>
            <h2>Interaction Modes</h2>
            <span className="badge">Your console</span>
          </header>
          <div className="mode-toggle">
            {modeList.map(item => (
              <button
                key={item.id}
                className={mode === item.id ? 'active' : ''}
                onClick={() => onModeChange(item.id)}
              >
                {item.label}
              </button>
            ))}
          </div>
          <div className="callout">
            <strong>{modeBlueprints[mode].label}</strong>
            <p>{blueprint.summary}</p>
          </div>
          <div className="spec-line">
            <strong>Recent Routes</strong>
            {messages.slice(-4).map(msg => (
              <span key={msg.id}>{formatAuthor(msg.authorId)} → {formatRecipient(msg.deliverTo)}</span>
            ))}
          </div>
        </React.Fragment>,
        document.getElementById('left-panel')
      );
    }

    function CenterPanel({ messages, sampleOutputs }) {
      return ReactDOM.createPortal(
        <React.Fragment>
          <header>
            <h2>Conversation Feed</h2>
            <span className="badge">Routing aware</span>
          </header>
          <div className="conversation-feed">
            {messages.map(msg => (
              <article key={msg.id} className="message-card" data-mode={msg.mode}>
                <header>
                  <span>{formatAuthor(msg.authorId)}</span>
                  <span>{msg.timestamp}</span>
                </header>
                <div className="route-pill">deliver → {formatRecipient(msg.deliverTo)}</div>
                <p>{msg.surface}</p>
              </article>
            ))}
          </div>
          <div className="section-block json-block">
            <h3>Mock Example Outputs</h3>
            {sampleOutputs.length === 0 && <p style={{ color: 'var(--muted)', fontSize: '12px' }}>Send prompts to generate mocked responses.</p>}
            {sampleOutputs.map((item, index) => (
              <pre key={index}>{JSON.stringify(item, null, 2)}</pre>
            ))}
          </div>
        </React.Fragment>,
        document.getElementById('center-panel')
      );
    }

    function RightPanel({
      mode,
      composerText,
      setComposerText,
      routeTo,
      setRouteTo,
      onSend,
      promptConfig,
      onConfigChange,
      agentPersonas,
      selectedPersona,
      setSelectedPersona,
      onPersonaChange,
      buildTemplateForAgent,
      showTemplate,
      setShowTemplate,
    }) {
      return ReactDOM.createPortal(
        <React.Fragment>
          <header>
            <h2>Prompt Console</h2>
            <span className="badge">Transparency</span>
          </header>
          <div className="composer">
            <div style={{ fontSize: '12px', color: 'var(--muted)' }}>
              You are speaking as <strong>the user</strong>.
            </div>
            <div>
              <label htmlFor="route">Route To</label>
              <select id="route" value={routeTo} onChange={event => setRouteTo(event.target.value)}>
                <option value="all">Council (all)</option>
                <option value="synthesis-agent">Synthesis Agent</option>
                {roster.map(philosopher => (
                  <option key={philosopher.id} value={philosopher.id}>{philosopher.name}</option>
                ))}
              </select>
            </div>
            <div>
              <label htmlFor="composer">Message</label>
              <textarea
                id="composer"
                value={composerText}
                onChange={event => setComposerText(event.target.value)}
                placeholder={modeBlueprints[mode].composer.placeholder}
              />
            </div>
            <div className="composer-actions">
              <span style={{ color: 'var(--muted)', fontSize: '12px' }}>Mode: {modeBlueprints[mode].label}</span>
              <button onClick={onSend}>Send with Recipient</button>
            </div>
          </div>

          <div className="section-block">
            <h3>Prompt Configuration</h3>
            <div>
              <label htmlFor="topic">Topic</label>
              <input id="topic" value={promptConfig.topic} onChange={e => onConfigChange('topic', e.target.value)} />
            </div>
            <div>
              <label htmlFor="situation">Situation Brief</label>
              <textarea id="situation" value={promptConfig.situationBrief} onChange={e => onConfigChange('situationBrief', e.target.value)} />
            </div>
            <div>
              <label htmlFor="tone">Tone</label>
              <input id="tone" value={promptConfig.tone} onChange={e => onConfigChange('tone', e.target.value)} />
            </div>
            <div>
              <label htmlFor="cadence">Cadence</label>
              <input id="cadence" value={promptConfig.cadence} onChange={e => onConfigChange('cadence', e.target.value)} />
            </div>
            <div>
              <label htmlFor="instruction">Instruction</label>
              <textarea id="instruction" value={promptConfig.roundInstruction} onChange={e => onConfigChange('roundInstruction', e.target.value)} />
            </div>
            <div style={{ display: 'grid', gap: '10px', gridTemplateColumns: 'repeat(2, minmax(0, 1fr))' }}>
              <div>
                <label htmlFor="surface">Surface Cap</label>
                <input id="surface" value={promptConfig.surfaceCap} onChange={e => onConfigChange('surfaceCap', e.target.value)} />
              </div>
              <div>
                <label htmlFor="translation">Translations</label>
                <input id="translation" value={promptConfig.translationPrefs} onChange={e => onConfigChange('translationPrefs', e.target.value)} />
              </div>
            </div>
          </div>

          <div className="section-block">
            <h3>Agent Card Editor</h3>
            <label htmlFor="persona-select">Select Agent</label>
            <select
              id="persona-select"
              value={selectedPersona}
              onChange={event => setSelectedPersona(event.target.value)}
            >
              {allAgents.map(agent => (
                <option key={agent.id} value={agent.id}>{agent.name}</option>
              ))}
            </select>
            <textarea
              value={agentPersonas[selectedPersona] || ''}
              onChange={event => onPersonaChange(selectedPersona, event.target.value)}
            />
          </div>

          <div className="section-block">
            <h3>Template Transparency</h3>
            <p style={{ fontSize: '12px', color: 'var(--muted)' }}>Each block shows the exact XML the selected agent would receive right now.</p>
            <div style={{ display: 'grid', gap: '10px' }}>
              {allAgents.map(agent => (
                <pre
                  key={agent.id}
                  className={`code-block ${routeTo === agent.id || (routeTo === 'all' && agent.id !== 'synthesis-agent') ? 'active' : ''}`}
                >{buildTemplateForAgent(agent.id)}</pre>
              ))}
            </div>
          </div>

          <div className="toggle-row">
            <button onClick={() => setShowTemplate(prev => !prev)}>
              {showTemplate ? 'Hide Base Template' : 'Show Base Template'}
            </button>
          </div>

          {showTemplate && (
            <pre>{renderTemplate({ agentId: routeTo, routeTo, mode, promptConfig, agentPersonas, messages: [] })}</pre>
          )}
        </React.Fragment>,
        document.getElementById('right-panel')
      );
    }

    function formatAuthor(authorId) {
      if (authorId === 'user') return 'You';
      if (authorId === 'synthesis-agent') return 'Synthesis Agent';
      const philosopher = roster.find(p => p.id === authorId);
      return philosopher ? philosopher.name : authorId;
    }

    function formatRecipient(value) {
      if (value === 'all') return 'council';
      if (value === 'synthesis-agent') return 'synthesis agent';
      const philosopher = roster.find(p => p.id === value);
      return philosopher ? philosopher.name : value;
    }

    ReactDOM.createRoot(document.body.appendChild(document.createElement('div'))).render(<App />);
  </script>
</body>
</html>
